define("mod_learningmap/learningmap",["exports","core/notification","core/templates","mod_learningmap/placestore"],(function(_exports,_notification,_templates,_placestore){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),_placestore=_interopRequireDefault(_placestore);_exports.init=()=>{var offset,dragel,upd1,upd2;_templates.default.prefetchTemplates(["mod_learningmap/cssskeleton"]);var selectedElement=null,firstPlace=null,secondPlace=null,lastTarget=null,elementForActivitySelector=null,touchstart=!1,touchend=!1,touchmove=0;let mapdiv=document.getElementById("learningmap-editor-map"),code=document.getElementById("id_introeditor_text"),colorChooserPlace=document.getElementById("learningmap-color-place"),colorChooserVisited=document.getElementById("learningmap-color-visited"),colorChooserPath=document.getElementById("learningmap-color-path"),activitySetting=document.getElementById("learningmap-activity-setting"),activitySelector=document.getElementById("learningmap-activity-selector"),activityStarting=document.getElementById("learningmap-activity-starting"),activityTarget=document.getElementById("learningmap-activity-target"),activityHiddenWarning=document.getElementById("learningmap-activity-hidden-warning"),advancedSettingsIcon=document.getElementById("learningmap-advanced-settings-icon"),treeView=document.querySelector(".fp-viewbar .fp-vb-tree");treeView&&treeView.setAttribute("style","display: none;");let iconView=document.querySelector(".fp-viewbar .fp-vb-icons");iconView&&setTimeout((()=>{iconView.dispatchEvent(new Event("click"))}),1e3),activitySelector&&(activitySelector.addEventListener("change",(function(){_placestore.default.setActivityId(elementForActivitySelector,activitySelector.value),activitySelector.value?document.getElementById(elementForActivitySelector).classList.remove("learningmap-emptyplace"):document.getElementById(elementForActivitySelector).classList.add("learningmap-emptyplace"),updateActivities(),updateCode()})),activityStarting.addEventListener("change",(function(){activityStarting.checked?_placestore.default.addStartingPlace(elementForActivitySelector):_placestore.default.removeStartingPlace(elementForActivitySelector),updateCode()})),activityTarget.addEventListener("change",(function(){activityTarget.checked?(_placestore.default.addTargetPlace(elementForActivitySelector),document.getElementById(elementForActivitySelector).classList.add("learningmap-targetplace")):(_placestore.default.removeTargetPlace(elementForActivitySelector),document.getElementById(elementForActivitySelector).classList.remove("learningmap-targetplace")),updateCode()})));let placestoreInput=document.getElementsByName("placestore")[0];if(placestoreInput&&_placestore.default.loadJSON(placestoreInput.value),updateActivities(),advancedSettingsIcon){let advancedSettings=document.getElementById("learningmap-advanced-settings");advancedSettingsIcon.addEventListener("click",(function(){null===advancedSettings.getAttribute("hidden")?advancedSettings.setAttribute("hidden",""):advancedSettings.removeAttribute("hidden")}));let advancedSettingsClose=document.getElementById("learningmap-advanced-settings-close");advancedSettingsClose&&advancedSettingsClose.addEventListener("click",(function(){advancedSettings.setAttribute("hidden","")}));let hidepaths=document.getElementById("learningmap-hidepaths");hidepaths&&(hidepaths.checked=_placestore.default.getHidePaths(),hidepaths.addEventListener("change",(function(){_placestore.default.setHidePaths(hidepaths.checked),updateCSS()})));let hidestroke=document.getElementById("learningmap-hidestroke");hidestroke&&(hidestroke.checked=_placestore.default.getStrokeOpacity()<1,hidestroke.addEventListener("change",(function(){_placestore.default.setStrokeOpacity(hidestroke.checked?0:1),updateCSS()})));let usecheckmark=document.getElementById("learningmap-usecheckmark");usecheckmark&&(usecheckmark.checked=_placestore.default.getUseCheckmark(),usecheckmark.addEventListener("change",(function(){_placestore.default.setUseCheckmark(usecheckmark.checked),updateCSS()})));let hover=document.getElementById("learningmap-hover");hover&&(hover.checked=_placestore.default.getHover(),hover.addEventListener("change",(function(){_placestore.default.setHover(hover.checked),updateCSS()})));let pulse=document.getElementById("learningmap-pulse");pulse&&(pulse.checked=_placestore.default.getPulse(),pulse.addEventListener("change",(function(){_placestore.default.setPulse(pulse.checked),updateCSS()})));let showall=document.getElementById("learningmap-showall");showall&&(showall.checked=_placestore.default.getShowall(),showall.addEventListener("change",(function(){_placestore.default.setShowall(showall.checked),updateCSS()})))}colorChooserPath&&(colorChooserPath.addEventListener("change",(function(){_placestore.default.setColor("stroke",colorChooserPath.value),updateCSS()})),colorChooserPath.value=_placestore.default.getColor("stroke")),colorChooserPlace&&(colorChooserPlace.addEventListener("change",(function(){_placestore.default.setColor("place",colorChooserPlace.value),updateCSS()})),colorChooserPlace.value=_placestore.default.getColor("place")),colorChooserVisited&&(colorChooserVisited.addEventListener("change",(function(){_placestore.default.setColor("visited",colorChooserVisited.value),updateCSS()})),colorChooserVisited.value=_placestore.default.getColor("visited")),code&&mapdiv&&(mapdiv.innerHTML=code.value),refreshBackgroundImage(),function(){let background=document.getElementById("learningmap-background-image");background&&background.addEventListener("load",(function(){background.removeAttribute("height");let height=parseInt(background.getBBox().height),width=background.getBBox().width;_placestore.default.setBackgroundDimensions(width,height),svg.setAttribute("viewBox","0 0 "+_placestore.default.width+" "+_placestore.default.height),background.setAttribute("width",width),background.setAttribute("height",height),updateCode()}))}(),updateCode();let svg=document.getElementById("learningmap-svgmap-"+_placestore.default.getMapid());function showContextMenu(e){if(unselectAll(),activitySetting)if(e.touches&&(e=e.touches[0]),e.target.classList.contains("learningmap-place")){e.target.classList.add("learningmap-selected-activity-selector");let activityId=_placestore.default.getActivityId(e.target.id),scalingFactor=mapdiv.clientWidth/800;activitySetting.style.setProperty("--pos-x",e.target.cx.baseVal.value*scalingFactor+"px"),activitySetting.style.setProperty("--pos-y",e.target.cy.baseVal.value*scalingFactor+"px"),activitySetting.style.setProperty("--map-width",mapdiv.clientWidth+"px"),activitySetting.style.setProperty("--map-height",mapdiv.clientHeight+"px"),activitySetting.style.display="block",document.getElementById("learningmap-activity-selector").value=activityId,document.getElementById("learningmap-activity-starting").checked=_placestore.default.isStartingPlace(e.target.id),document.getElementById("learningmap-activity-target").checked=_placestore.default.isTargetPlace(e.target.id),elementForActivitySelector=e.target.id,updateActivities()}else hideContextMenu()}function hideContextMenu(){let e=document.getElementById(elementForActivitySelector);e&&e.classList.remove("learningmap-selected-activity-selector"),activitySetting.style.display="none"}!function(el){dragel=el,el&&(el.addEventListener("mousedown",startDrag),el.addEventListener("mousemove",drag),el.addEventListener("mouseup",endDrag),el.addEventListener("mouseleave",endDrag),el.addEventListener("touchstart",(function(evt){evt.cancelable&&evt.preventDefault();evt.target.classList.contains("learningmap-draggable")?(touchstart?(dblclickHandler(evt),touchstart=!1):(touchstart=!0,touchmove=0,touchend=!1,setTimeout((evt=>{touchmove<3&&!touchend&&(evt.touches&&(evt=evt.touches[0]),showContextMenu(evt))}),2e3,evt),setTimeout((()=>{touchstart=!1}),300)),startDrag(evt)):touchstart?(dblclickHandler(evt),touchstart=!1):(touchstart=!0,touchend=!1,touchmove=0,setTimeout((()=>{touchstart=!1}),300))})),el.addEventListener("touchmove",drag),el.addEventListener("touchend",endTouch),el.addEventListener("touchleave",endTouch),el.addEventListener("touchcancel",endTouch));function startDrag(evt){evt.cancelable&&evt.preventDefault(),evt.target.classList.contains("learningmap-draggable")&&(selectedElement=evt.target,(offset=getMousePosition(evt)).x-=parseInt(selectedElement.getAttributeNS(null,"cx")),offset.y-=parseInt(selectedElement.getAttributeNS(null,"cy")),upd1=_placestore.default.getPathsWithFid(selectedElement.id),upd2=_placestore.default.getPathsWithSid(selectedElement.id))}function drag(evt){if(evt.cancelable&&evt.preventDefault(),touchmove++,selectedElement){var coord=getMousePosition(evt);let cx=coord.x-offset.x,cy=coord.y-offset.y;selectedElement.setAttributeNS(null,"cx",cx),selectedElement.setAttributeNS(null,"cy",cy),upd1.forEach((function(p){let d=document.getElementById(p.id);if(null!==d)if("path"==d.nodeName){let pathDeclaration=d.getAttribute("d"),newPathDeclaration="M "+cx+" "+cy+" L"+pathDeclaration.split("L")[1];d.setAttribute("d",newPathDeclaration)}else d.setAttribute("x1",cx),d.setAttribute("y1",cy)})),upd2.forEach((function(p){let d=document.getElementById(p.id);if(null!==d)if("path"==d.nodeName){let newPathDeclaration=d.getAttribute("d").split("L")[0]+"L "+cx+" "+cy;d.setAttribute("d",newPathDeclaration)}else d.setAttribute("x2",cx),d.setAttribute("y2",cy)}))}}function endDrag(evt){evt.cancelable&&evt.preventDefault(),selectedElement=null,unselectAll(),updateCode()}function endTouch(evt){touchmove<3&&touchstart&&clickHandler(evt),touchend=!0,evt.cancelable&&evt.preventDefault(),selectedElement=null,endDrag(evt)}}(svg),updateCSS(),mapdiv&&(mapdiv.addEventListener("dblclick",dblclickHandler),mapdiv.addEventListener("click",clickHandler),mapdiv.addEventListener("contextmenu",(function(e){e.preventDefault(),showContextMenu(e)}),!1));let backgroundfileNode=document.getElementById("id_introeditor_itemid_fieldset");if(backgroundfileNode){new MutationObserver(refreshBackgroundImage).observe(backgroundfileNode,{attributes:!0,childList:!0,subtree:!0})}function getMousePosition(evt){var CTM=dragel.getScreenCTM();return evt.touches&&(evt=evt.touches[0]),{x:(evt.clientX-CTM.e)/CTM.a,y:(evt.clientY-CTM.f)/CTM.d}}function updateCode(){code&&mapdiv&&(code.innerHTML=mapdiv.innerHTML),placestoreInput&&(document.getElementsByName("placestore")[0].value=JSON.stringify(_placestore.default.getPlacestore()))}function dblclickHandler(event){hideContextMenu(),unselectAll(),event.target.classList.contains("learningmap-mapcontainer")||event.target.classList.contains("learningmap-background-image")?function(event){let placesgroup=document.getElementById("placesGroup"),placeId="p"+_placestore.default.getId(),linkId="a"+_placestore.default.getId();var CTM=event.target.getScreenCTM();event.touches&&(event=event.touches[0]);let cx=(event.clientX-CTM.e)/CTM.a,cy=(event.clientY-CTM.f)/CTM.d;placesgroup.appendChild(function(child,id){let title=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,link=document.createElementNS("http://www.w3.org/2000/svg","a");link.setAttribute("id",id),link.setAttribute("xlink:href",""),link.appendChild(child),null===title||link.appendChild(title);return link}(function(x,y,r,classes,id){let circle=document.createElementNS("http://www.w3.org/2000/svg","circle");return circle.setAttribute("class",classes),circle.setAttribute("id",id),circle.setAttribute("cx",x),circle.setAttribute("cy",y),circle.setAttribute("r",r),circle}(cx,cy,10,"learningmap-place learningmap-draggable learningmap-emptyplace",placeId),linkId,function(id){let title=document.createElementNS("http://www.w3.org/2000/svg","title");return title.setAttribute("id",id),title}("title"+placeId))),_placestore.default.addPlace(placeId,linkId)}(event):event.target.classList.contains("learningmap-place")?lastTarget==event.target.id?(lastTarget=null,clickHandler(event)):function(event){let place=document.getElementById(event.target.id),parent=place.parentNode;id=event.target.id,_placestore.default.getTouchingPaths(id).forEach((function(e){removePath(e.id)})),_placestore.default.removePlace(event.target.id),parent.removeChild(place),parent.parentNode.removeChild(parent),updateCode();var id}(event):event.target.classList.contains("learningmap-path")&&removePath(event.target.id),updateCode()}function clickHandler(event){if(event.preventDefault(),hideContextMenu(),event.target.classList.contains("learningmap-place")&&null===selectedElement)if(null===firstPlace)firstPlace=event.target.id,document.getElementById(firstPlace).classList.add("learningmap-selected");else{secondPlace=event.target.id;let fid=parseInt(firstPlace.replace("p","")),sid=parseInt(secondPlace.replace("p",""));if(sid==fid)return;if(sid<fid){let z=sid;sid=fid,fid=z}!function(fid,sid){let pid="p"+fid+"_"+sid;if(null===document.getElementById(pid)){let pathsgroup=document.getElementById("pathsGroup"),first=document.getElementById("p"+fid),second=document.getElementById("p"+sid);pathsgroup&&first&&second&&(pathsgroup.appendChild(function(x1,y1,x2,y2,classes,id){let path=document.createElementNS("http://www.w3.org/2000/svg","path");return path.setAttribute("class",classes),path.setAttribute("id",id),path.setAttribute("d","M "+x1+" "+y1+" L "+x2+" "+y2),path}(first.cx.baseVal.value,first.cy.baseVal.value,second.cx.baseVal.value,second.cy.baseVal.value,"learningmap-path",pid)),_placestore.default.addPath(pid,"p"+fid,"p"+sid))}}(fid,sid);let first=document.getElementById(firstPlace);first&&first.classList.remove("learningmap-selected"),firstPlace=null,lastTarget=secondPlace,secondPlace=null}else unselectAll(),firstPlace=null}function unselectAll(){Array.from(document.getElementsByClassName("learningmap-selected")).forEach((function(e){e.classList.remove("learningmap-selected")})),Array.from(document.getElementsByClassName("learningmap-selected-activity-selector")).forEach((function(e){e.classList.remove("learningmap-selected-activity-selector")}))}function removePath(id){let path=document.getElementById(id);null!==path&&(path.parentNode.removeChild(path),_placestore.default.removePath(id))}function refreshBackgroundImage(){let previewimage=document.getElementsByClassName("realpreview");if(previewimage.length>0){let background=document.getElementById("learningmap-background-image"),backgroundurl=previewimage[0].getAttribute("src").split("?")[0];previewimage[0].getAttribute("src").split("?")[1].includes("&oid=")&&(backgroundurl+="?oid="+previewimage[0].getAttribute("src").split("&oid=")[1]),background.setAttribute("xlink:href",backgroundurl)}}function updateCSS(){_templates.default.renderForPromise("mod_learningmap/cssskeleton",_placestore.default.getPlacestore()).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.replaceNode("#learningmap-svgstyle",html,js),updateCode(),!0})).catch((ex=>(0,_notification.exception)(ex)))}function updateActivities(){let activities=_placestore.default.getAllActivities(),options=Array.from(activitySelector.getElementsByTagName("option"));activityHiddenWarning.setAttribute("hidden",""),options.forEach((function(n){activities.includes(n.value)?(n.classList.add("learningmap-used-activity"),n.selected&&1==n.getAttribute("data-activity-hidden")&&activityHiddenWarning.removeAttribute("hidden")):n.classList.remove("learningmap-used-activity")}))}}}));

//# sourceMappingURL=learningmap.min.js.map