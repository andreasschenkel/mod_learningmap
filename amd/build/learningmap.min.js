define("mod_learningmap/learningmap",["exports","core/notification","core/templates","mod_learningmap/placestore","mod_learningmap/svg","./shapes"],(function(_exports,_notification,_templates,_placestore,_svg,_shapes){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),_placestore=_interopRequireDefault(_placestore),_svg=_interopRequireDefault(_svg),_shapes=_interopRequireDefault(_shapes);const targetPoints_firstPoint=1,targetPoints_secondPoint=2,targetPoints_bezierPoint=3,pathTypes_line=1,pathTypes_quadraticbezier=2;_exports.init=()=>{var offset,dragel,pathsToUpdateFirstPoint,pathsToUpdateSecondPoint;_templates.default.prefetchTemplates(["mod_learningmap/cssskeleton"]);var selectedElement=null,firstPlace=null,secondPlace=null,lastTarget=null,elementForActivitySelector=null,touchstart=!1,touchend=!1,touchmove=0;let mapdiv=document.getElementById("learningmap-editor-map"),code=document.getElementById("id_svgcode"),activitySetting=document.getElementById("learningmap-activity-setting"),activitySelector=document.getElementById("learningmap-activity-selector"),activityStarting=document.getElementById("learningmap-activity-starting"),activityTarget=document.getElementById("learningmap-activity-target"),activityHiddenWarning=document.getElementById("learningmap-activity-hidden-warning"),advancedSettingsIcon=document.getElementById("learningmap-advanced-settings-icon"),treeView=document.querySelector(".fp-viewbar .fp-vb-tree");treeView&&treeView.setAttribute("style","display: none;");let iconView=document.querySelector(".fp-viewbar .fp-vb-icons");iconView&&setTimeout((()=>{iconView.dispatchEvent(new Event("click"))}),1e3),activitySelector&&(activitySelector.addEventListener("change",(function(){if(_placestore.default.setActivityId(elementForActivitySelector,activitySelector.value),activitySelector.value){let text=document.getElementById("text"+elementForActivitySelector);text&&(text.textContent=activitySelector.querySelector('option[value="'+activitySelector.value+'"]').textContent);let title=document.getElementById("title"+elementForActivitySelector);title&&(title.textContent=activitySelector.querySelector('option[value="'+activitySelector.value+'"]').textContent),document.getElementById(elementForActivitySelector).classList.remove("learningmap-emptyplace")}else document.getElementById(elementForActivitySelector).classList.add("learningmap-emptyplace");updateActivities(),updateCode()})),activityStarting.addEventListener("change",(function(){activityStarting.checked?_placestore.default.addStartingPlace(elementForActivitySelector):_placestore.default.removeStartingPlace(elementForActivitySelector),updateCode()})),activityTarget.addEventListener("change",(function(){activityTarget.checked?(_placestore.default.addTargetPlace(elementForActivitySelector),document.getElementById(elementForActivitySelector).classList.add("learningmap-targetplace")):(_placestore.default.removeTargetPlace(elementForActivitySelector),document.getElementById(elementForActivitySelector).classList.remove("learningmap-targetplace")),updateCode()})));let placestoreInput=document.getElementsByName("placestore")[0];if(placestoreInput&&_placestore.default.loadJSON(placestoreInput.value),updateActivities(),advancedSettingsIcon){let advancedSettings=document.getElementById("learningmap-advanced-settings");advancedSettingsIcon.addEventListener("click",(function(){null===advancedSettings.getAttribute("hidden")?hideAdvancedSettings():(advancedSettings.removeAttribute("hidden"),hideContextMenu())}));let advancedSettingsClose=document.getElementById("learningmap-advanced-settings-close");advancedSettingsClose&&advancedSettingsClose.addEventListener("click",(function(){advancedSettings.setAttribute("hidden","")})),advancedSettingsLogic("hidepaths",_placestore.default.getHidePaths,_placestore.default.setHidePaths),advancedSettingsLogic("usecheckmark",_placestore.default.getUseCheckmark,_placestore.default.setUseCheckmark),advancedSettingsLogic("hover",_placestore.default.getHover,_placestore.default.setHover),advancedSettingsLogic("pulse",_placestore.default.getPulse,_placestore.default.setPulse),advancedSettingsLogic("showall",_placestore.default.getShowall,_placestore.default.setShowall),advancedSettingsLogic("hidestroke",_placestore.default.getHideStroke,_placestore.default.setHideStroke),advancedSettingsLogic("showtext",_placestore.default.getShowText,_placestore.default.setShowText,(function(){let options=Array.from(activitySelector.getElementsByTagName("option")),places=_placestore.default.getPlaces();for(const place of places)if(null===document.getElementById("text"+place.id)){let content="";for(const option of options)if(option.value==place.linkedActivity){content=option.textContent;break}let placeNode=mapsvg.findOne("#"+place.id);text("text"+place.id,content,placeNode.cx(),placeNode.cy()).addTo(placeNode.parent())}})),advancedSettingsLogic("slicemode",_placestore.default.getSliceMode,_placestore.default.setSliceMode),advancedSettingsLogic("showwaygone",_placestore.default.getShowWayGone,_placestore.default.setShowWayGone)}colorChooserLogic("stroke","text"),colorChooserLogic("place"),colorChooserLogic("visited"),code&&mapdiv&&(mapdiv.innerHTML=code.value),refreshBackgroundImage(),function(){let background=document.getElementById("learningmap-background-image");background&&background.addEventListener("load",(function(){background.removeAttribute("height");let height=parseInt(background.getBBox().height),width=background.getBBox().width;_placestore.default.setBackgroundDimensions(width,height),svgel.setAttribute("viewBox","0 0 "+_placestore.default.width+" "+_placestore.default.height),background.setAttribute("width",width),background.setAttribute("height",height),updateCode()}))}(),updateCode();let svgel=document.getElementById("learningmap-svgmap-"+_placestore.default.getMapid());!function(el){dragel=el,el&&(el.addEventListener("mousedown",startDrag),el.addEventListener("mousemove",drag),el.addEventListener("mouseup",endDrag),el.addEventListener("mouseleave",endDrag),el.addEventListener("touchstart",(function(evt){evt.cancelable&&evt.preventDefault();evt.target.classList.contains("learningmap-draggable")||"text"==evt.target.nodeName||"path"==evt.target.nodeName?(touchstart?(dblclickHandler(evt),touchstart=!1):(touchstart=!0,touchmove=0,touchend=!1,setTimeout((evt=>{touchmove<3&&!touchend&&(evt.touches&&(evt=evt.touches[0]),showContextMenu(evt))}),2e3,evt),setTimeout((()=>{touchstart=!1}),300)),startDrag(evt)):touchstart?(dblclickHandler(evt),touchstart=!1):(touchstart=!0,touchend=!1,touchmove=0,setTimeout((()=>{touchstart=!1}),300))})),el.addEventListener("touchmove",drag),el.addEventListener("touchend",endTouch),el.addEventListener("touchleave",endTouch),el.addEventListener("touchcancel",endTouch));function startDrag(evt){if(evt.cancelable&&evt.preventDefault(),pathsToUpdateFirstPoint=[],pathsToUpdateSecondPoint=[],evt.target.classList.contains("learningmap-draggable")){let svgel=getSVGShape(selectedElement=evt.target);(offset=getMousePosition(evt)).x-=svgel.cx(),offset.y-=svgel.cy(),pathsToUpdateFirstPoint=_placestore.default.getPathsWithFid(evt.target.id),pathsToUpdateSecondPoint=_placestore.default.getPathsWithSid(evt.target.id)}else if("text"==evt.target.nodeName){let svgel=getSVGShape(selectedElement=evt.target),place=svgel.parent().findOne(".learningmap-place");(offset=getMousePosition(evt)).x-=svgel.attr("dx")+place.cx(),offset.y-=svgel.attr("dy")+place.cy()}else if("path"==evt.target.nodeName){selectedElement=evt.target,offset=getMousePosition(evt);let pathPoint=transformCoordinates(evt.layerX,evt.layerY);offset.x+=pathPoint.x,offset.y+=pathPoint.y}}function drag(evt){if(evt.cancelable&&evt.preventDefault(),touchmove++,selectedElement){var coord=getMousePosition(evt);let cx=coord.x-offset.x,cy=coord.y-offset.y;console.log(selectedElement);let closest=selectedElement.closest(".learningmap-place");if(console.log(closest),closest&&(selectedElement=closest),selectedElement.classList.contains("learningmap-place")){let placeel=mapsvg.findOne("#"+selectedElement.id);placeel.center(cx,cy);let textNode=mapsvg.findOne("#text"+selectedElement.id);null!==textNode&&textNode.amove(cx,cy),pathsToUpdateFirstPoint.forEach((function(path){let pathElement=getSVGShape(path);null!==pathElement&&("path"==pathElement.type?pathElement.attr({d:updatePathDeclaration(pathElement.attr("d"),cx,cy,targetPoints_firstPoint)}):pathElement.attr({x1:cx,y1:cy}))})),pathsToUpdateSecondPoint.forEach((function(path){let pathElement=getSVGShape(path);null!==pathElement&&("path"==pathElement.type?pathElement.attr({d:updatePathDeclaration(pathElement.attr("d"),cx,cy,targetPoints_secondPoint)}):pathElement.attr({x2:cx,y2:cy}))})),_placestore.default.setBbox(selectedElement.id,placeel.parent().bbox())}else if("text"==selectedElement.nodeName){let textel=getSVGShape(selectedElement),place=textel.parent().findOne(".learningmap-place"),dx=cx-place.cx(),dy=cy-place.cy();textel.attr({dx:dx,dy:dy}),_placestore.default.setBbox(place.node.id,textel.parent().bbox())}else"path"==selectedElement.nodeName&&selectedElement.setAttribute("d",updatePathDeclaration(selectedElement.getAttribute("d"),coord.x,coord.y,targetPoints_bezierPoint))}}function endDrag(evt){evt.cancelable&&evt.preventDefault(),selectedElement=null,unselectAll(),updateCode()}function endTouch(evt){selectedElement=null,touchend=!0,touchmove<3&&touchstart?clickHandler(evt):endDrag(evt),evt.cancelable&&evt.preventDefault()}function updatePathDeclaration(oldDefinition,targetX,targetY){let targetP=arguments.length>3&&void 0!==arguments[3]?arguments[3]:targetPoints_firstPoint,parts=oldDefinition.split(" "),fromX=0,fromY=0,toX=0,toY=0,bezierX=0,bezierY=0,pathType=pathTypes_line;for(let i=0;i<parts.length;i++)"M"==parts[i]&&(fromX=parseInt(parts[i+1]),fromY=parseInt(parts[i+2]),i+=2),"L"==parts[i]&&(toX=parseInt(parts[i+1]),toY=parseInt(parts[i+2]),i+=2),"Q"==parts[i]&&(bezierX=parseInt(parts[i+1]),bezierY=parseInt(parts[i+2]),toX=parseInt(parts[i+3]),toY=parseInt(parts[i+4]),i+=4,pathType=pathTypes_quadraticbezier);switch(targetP){case targetPoints_firstPoint:fromX=targetX,fromY=targetY;break;case targetPoints_secondPoint:toX=targetX,toY=targetY;break;case targetPoints_bezierPoint:bezierX=2*targetX-.5*(fromX+toX),bezierY=2*targetY-.5*(fromY+toY),pathType=pathTypes_quadraticbezier}return pathType==pathTypes_quadraticbezier?"M "+fromX+" "+fromY+" Q "+bezierX+" "+bezierY+", "+toX+" "+toY:"M "+fromX+" "+fromY+" L "+toX+" "+toY}}(svgel);var mapsvg=(0,_svg.default)().SVG("#learningmap-svgmap-"+_placestore.default.getMapid());function showContextMenu(e){if(unselectAll(),hideAdvancedSettings(),activitySetting&&null!==document.getElementById(e.target.id))if(e.touches&&(e=e.touches[0]),e.target.classList.contains("learningmap-place")){let element=getSVGShape(e.target.id);e.target.classList.add("learningmap-selected-activity-selector");let activityId=_placestore.default.getActivityId(e.target.id),scalingFactor=mapdiv.clientWidth/800;activitySetting.style.setProperty("--pos-x",element.cx()*scalingFactor+"px"),activitySetting.style.setProperty("--pos-y",element.cy()*scalingFactor+"px"),activitySetting.style.setProperty("--map-width",mapdiv.clientWidth+"px"),activitySetting.style.setProperty("--map-height",mapdiv.clientHeight+"px"),activitySetting.style.display="block",document.getElementById("learningmap-activity-selector").value=activityId,document.getElementById("learningmap-activity-starting").checked=_placestore.default.isStartingPlace(e.target.id),document.getElementById("learningmap-activity-target").checked=_placestore.default.isTargetPlace(e.target.id),elementForActivitySelector=e.target.id,updateActivities()}else hideContextMenu(),hideAdvancedSettings()}function hideContextMenu(){let e=document.getElementById(elementForActivitySelector);e&&e.classList.remove("learningmap-selected-activity-selector"),activitySetting.style.display="none"}updateCSS(),mapdiv&&(mapdiv.addEventListener("dblclick",dblclickHandler),mapdiv.addEventListener("click",clickHandler),mapdiv.addEventListener("contextmenu",(function(e){e.preventDefault(),showContextMenu(e)}),!1));let backgroundfileNode=document.getElementById("id_backgroundfile_fieldset");if(backgroundfileNode){new MutationObserver(refreshBackgroundImage).observe(backgroundfileNode,{attributes:!0,childList:!0,subtree:!0})}function getMousePosition(evt){return evt.touches&&(evt=evt.touches[0]),transformCoordinates(evt.clientX,evt.clientY)}function transformCoordinates(x,y){var CTM=dragel.getScreenCTM();return{x:(x-CTM.e)/CTM.a,y:(y-CTM.f)/CTM.d}}function getSVGShape(element){return"object"==typeof element?mapsvg.findOne("#"+element.id):mapsvg.findOne("#"+element)}function updateCode(){code&&mapdiv&&(code.innerHTML=mapdiv.innerHTML),placestoreInput&&(document.getElementsByName("placestore")[0].value=JSON.stringify(_placestore.default.getPlacestore()))}function dblclickHandler(event){hideContextMenu(),hideAdvancedSettings(),unselectAll(),event.target.classList.contains("learningmap-mapcontainer")||event.target.classList.contains("learningmap-background-image")?function(event){let placesgroup=mapsvg.findOne("#placesGroup"),placeId="p"+_placestore.default.getId(),linkId="a"+_placestore.default.getId();var CTM=event.target.getScreenCTM();event.touches&&(event=event.touches[0]);let cx=(event.clientX-CTM.e)/CTM.a,cy=(event.clientY-CTM.f)/CTM.d,svglink=function(child,id){let title=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,text=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return mapsvg.link("").id(id).add(child).add(title).add(text)}(_shapes.default.emoji(mapsvg,cx,cy,10,"learningmap-place learningmap-draggable learningmap-emptyplace",placeId),linkId,(id="title"+placeId,mapsvg.element("title").id(id)),text("text"+placeId,"",cx,cy));var id;svglink.addTo(placesgroup),_placestore.default.addPlace(placeId,linkId,null,svglink.bbox())}(event):event.target.classList.contains("learningmap-place")?lastTarget==event.target.id?(lastTarget=null,clickHandler(event)):function(event){let place=getSVGShape(event.target.id);id=event.target.id,_placestore.default.getTouchingPaths(id).forEach((function(e){removePath(e.id)})),_placestore.default.removePlace(event.target.id),place.parent().remove(),updateCode();var id}(event):event.target.classList.contains("learningmap-path")&&removePath(event.target.id),updateCode()}function text(id,content,x,y){return mapsvg.text().attr({dx:15,dy:15}).plain(content).move(x,y).id(id)}function clickHandler(event){if(event.preventDefault(),hideContextMenu(),hideAdvancedSettings(),event.target.classList.contains("learningmap-place")&&null===selectedElement)if(null===firstPlace)firstPlace=event.target.id,document.getElementById(firstPlace).classList.add("learningmap-selected");else{secondPlace=event.target.id;let fid=parseInt(firstPlace.replace("p","")),sid=parseInt(secondPlace.replace("p",""));if(sid==fid)return;if(sid<fid){let z=sid;sid=fid,fid=z}!function(fid,sid){let pid="p"+fid+"_"+sid;if(null===document.getElementById(pid)){let pathsgroup=mapsvg.findOne("#pathsGroup"),first=mapsvg.findOne("#p"+fid),second=mapsvg.findOne("#p"+sid);if(pathsgroup&&first&&second){(x1=first.cx(),y1=first.cy(),x2=second.cx(),y2=second.cy(),classes="learningmap-path",id=pid,mapsvg.path("M "+x1+" "+y1+" L "+x2+" "+y2).attr({class:classes}).id(id)).addTo(pathsgroup),_placestore.default.addPath(pid,"p"+fid,"p"+sid)}}var x1,y1,x2,y2,classes,id}(fid,sid);let first=document.getElementById(firstPlace);first&&first.classList.remove("learningmap-selected"),firstPlace=null,lastTarget=secondPlace,secondPlace=null}else unselectAll(),firstPlace=null}function unselectAll(){Array.from(document.getElementsByClassName("learningmap-selected")).forEach((function(e){e.classList.remove("learningmap-selected")})),Array.from(document.getElementsByClassName("learningmap-selected-activity-selector")).forEach((function(e){e.classList.remove("learningmap-selected-activity-selector")}))}function removePath(id){let path=getSVGShape(id);null!==path&&(path.remove(),_placestore.default.removePath(id))}function refreshBackgroundImage(){let previewimage=document.getElementsByClassName("realpreview");if(previewimage.length>0){let background=document.getElementById("learningmap-background-image"),backgroundurl=previewimage[0].getAttribute("src").split("?")[0];previewimage[0].getAttribute("src").split("?")[1].includes("&oid=")&&(backgroundurl+="?oid="+previewimage[0].getAttribute("src").split("&oid=")[1]),background.setAttribute("xlink:href",backgroundurl)}}function updateCSS(){_templates.default.renderForPromise("mod_learningmap/cssskeleton",_placestore.default.getPlacestore()).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.replaceNode("#learningmap-svgstyle",html,js),updateCode(),!0})).catch((ex=>(0,_notification.exception)(ex)))}function updateActivities(){let activities=_placestore.default.getAllActivities(),options=Array.from(activitySelector.getElementsByTagName("option"));activityHiddenWarning.setAttribute("hidden",""),options.forEach((function(n){activities.includes(n.value)?(n.classList.add("learningmap-used-activity"),n.selected&&1==n.getAttribute("data-activity-hidden")&&activityHiddenWarning.removeAttribute("hidden")):n.classList.remove("learningmap-used-activity")}))}function colorChooserLogic(name){let secondValue=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",colorChooser=document.getElementById("learningmap-color-"+name);colorChooser&&(colorChooser.addEventListener("change",(function(){_placestore.default.setColor(name,colorChooser.value),""!=secondValue&&_placestore.default.setColor(secondValue,colorChooser.value),updateCSS()})),colorChooser.value=_placestore.default.getColor(name))}function advancedSettingsLogic(name,getCall,setCall){let callback=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,settingItem=document.getElementById("learningmap-advanced-setting-"+name);settingItem&&(settingItem.checked=getCall.call(_placestore.default),settingItem.addEventListener("change",(function(){setCall.call(_placestore.default,settingItem.checked),null!==callback&&callback(),updateCSS()})))}function hideAdvancedSettings(){document.getElementById("learningmap-advanced-settings").setAttribute("hidden","")}}}));

//# sourceMappingURL=learningmap.min.js.map